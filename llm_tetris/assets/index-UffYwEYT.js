(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(o){if(o.ep)return;o.ep=!0;const i=r(o);fetch(o.href,i)}})();const d=10,y=20,a=30,O={I:[[1,1,1,1]],J:[[1,0,0],[1,1,1]],L:[[0,0,1],[1,1,1]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0]],T:[[0,1,0],[1,1,1]],Z:[[1,1,0],[0,1,1]]},k={I:"#00f0f0",O:"#f0f000",T:"#a000f0",S:"#00f000",Z:"#f00000",J:"#0000f0",L:"#f0a000"};let x=0,p=1,s=Array(y).fill().map(()=>Array(d).fill(0)),e=null,I=null,h=null,g=null,P=!1,A,B;class M{constructor(n,r){this.shape=n,this.color=r,this.x=Math.floor(d/2)-Math.floor(n[0].length/2),this.y=0}}function _(t){P=t}function b(){return P}function S(){const t=Object.keys(O),n=t[Math.floor(Math.random()*t.length)];return new M(O[n],k[n])}function v(){h.clearRect(0,0,h.canvas.width,h.canvas.height);for(let t=0;t<y;t++)for(let n=0;n<d;n++)s[t][n]&&(h.fillStyle=s[t][n],h.fillRect(n*a,t*a,a-1,a-1));e&&(h.fillStyle=e.color,e.shape.forEach((t,n)=>{t.forEach((r,l)=>{r&&h.fillRect((e.x+l)*a,(e.y+n)*a,a-1,a-1)})}))}function N(){g.clearRect(0,0,g.canvas.width,g.canvas.height),I&&(g.fillStyle=I.color,I.shape.forEach((t,n)=>{t.forEach((r,l)=>{r&&g.fillRect(l*a/2+20,n*a/2+20,a/2-1,a/2-1)})}))}function u(t,n,r,l){return t.shape.every((o,i)=>o.every((c,f)=>{let m=n+f,w=r+i;return c===0||m>=0&&m<d&&w>=0&&w<y&&!l[w][m]}))}function R(t,n){n.shape.forEach((r,l)=>{r.forEach((o,i)=>{o&&(t[n.y+l][n.x+i]=n.color)})})}function D(t){let n=0;for(let r=y-1;r>=0;r--)t[r].every(l=>l!==0)&&(t.splice(r,1),t.unshift(Array(d).fill(0)),n++,r++);if(n>0&&typeof document<"u"){x+=n*100*p;const r=document.getElementById("score");if(r&&(r.textContent=x),x>=p*1e3){p++;const l=document.getElementById("level");l&&(l.textContent=p)}}return n}function L(){e&&u(e,e.x,e.y+1,s)?e.y++:(e&&(R(s,e),D(s)),e=I||S(),I=S(),N(),u(e,e.x,e.y,s)||(alert(`遊戲結束! 得分: ${x}`),G())),v()}function G(){s=Array(y).fill().map(()=>Array(d).fill(0)),x=0,p=1,document.getElementById("score").textContent=x,document.getElementById("level").textContent=p,C()}function H(t){return t[0].map((n,r)=>t.map(l=>l[r]).reverse())}let C=null;function T(t){C=function(){B&&clearInterval(B),A&&clearInterval(A),b()?A=setInterval(t,1e3/p):B=setInterval(L,1e3/p)},C()}function X(t){h=t.getElementById("game-board").getContext("2d"),g=t.getElementById("next-piece").getContext("2d"),t.addEventListener("keydown",n=>{if(!(!e||b()))switch(n.key){case"ArrowLeft":u(e,e.x-1,e.y,s)&&(e.x--,v());break;case"ArrowRight":u(e,e.x+1,e.y,s)&&(e.x++,v());break;case"ArrowDown":u(e,e.x,e.y+1,s)&&(e.y++,v());break;case"ArrowUp":const r=e.shape[0].map((o,i)=>e.shape.map(c=>c[i]).reverse()),l=e.shape;e.shape=r,u(e,e.x,e.y,s)||(e.shape=l),v();break;case" ":for(;u(e,e.x,e.y+1,s);)e.y++;L();break}}),I=S(),T()}const E={landingHeight:.5,rowsCleared:.7,holes:-.9,bumpiness:-.2};function Z(t){let n=0;for(let r=0;r<d;r++){let l=!1;for(let o=0;o<y;o++)t[o][r]?l=!0:l&&n++}return n}function q(t){let n=0,r=0;for(let l=0;l<d;l++){let o=0;for(let i=0;i<y;i++)if(t[i][l]){o=y-i;break}l>0&&(n+=Math.abs(o-r)),r=o}return n}function F(t,n){const r=n.map(i=>[...i]);let l=0;for(;u(t,t.x,l+1,s);)l++;t.y=l,R(r,t);const o=r.reduce((i,c)=>c.every(f=>f!==0)?i+1:i,0);return t.y*E.landingHeight+o*E.rowsCleared+Z(r)*E.holes+q(r)*E.bumpiness}function J(){let t=-1/0,n=0,r=0;({...e});for(let l=0;l<4;l++){const o=new M(e.shape,e.color);for(let f=0;f<l;f++)o.shape=H(o.shape);const i=-Math.floor(o.shape[0].length/2),c=d-Math.floor(o.shape[0].length/2);for(let f=i;f<c;f++)if(o.x=f,o.y=0,u(o,o.x,o.y,s)){const m=F(o,s);m>t&&(t=m,n=l,r=f)}}return{bestRotation:n,bestX:r}}function K(){if(!b()||!e)return;const{bestRotation:t,bestX:n}=J();for(let r=0;r<t;r++)e.shape=H(e.shape);for(e.x=n;u(e,e.x,e.y+1,s);)e.y++;v(),L()}function U(t){t.getElementById("ai-toggle").addEventListener("click",()=>{_(!b()),t.getElementById("ai-status").textContent=b()?"(已啟用)":"(已停用)",T(K)})}document.querySelector("#app").innerHTML=`
    <div class="game-container">
        <canvas id="game-board" width="300" height="600"></canvas>
        <div class="game-info">
            <h2>分數: <span id="score">0</span></h2>
            <h3>等級: <span id="level">1</span></h3>
            <div class="next-piece">
                <canvas id="next-piece" width="100" height="100"></canvas>
            </div>
            <div class="ai-controls">
                <button id="ai-toggle" class="btn btn-outline-light">啟用AI</button>
                <span id="ai-status" class="text-light">(已停用)</span>
            </div>
            <div class="controls">
                <p>控制方式:</p>
                <p>←→: 移動</p>
                <p>↑: 旋轉</p>
                <p>↓: 加速</p>
                <p>空格: 瞬間落下</p>
            </div>
        </div>
    </div>
`;X(document);U(document);
